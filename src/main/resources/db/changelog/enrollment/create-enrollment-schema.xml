<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <changeSet id="create-tbl_enrollment_06_09_2025_07_03" author="${author1}" context="${context_development}">
        <comment>Create Enrollment Schema</comment>

        <createTable tableName="${tbl_enrollment}">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="batch_id" type="INT">
                <constraints nullable="false"
                             foreignKeyName="fk_enrollment_batch"
                             references="${tbl_batch}(id)"
                             unique="true"/>
            </column>
            <column name="user_id" type="INT">
                <constraints nullable="false"
                             foreignKeyName="fk_enrollment_user"
                             references="${tbl_user}(id)"
                             unique="true"/>
            </column>
            <column name="enrollment_date" type="DATE">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add-check-constraint_06_09_2025_07_05" author="${author1}" context="${context_development}">
        <comment>Adds a trigger to enforce that only users with the 'TRAINEE' role can be enrolled.</comment>
        <sql endDelimiter="//">
            CREATE TRIGGER trg_check_enrollment_trainee
                BEFORE INSERT ON tbl_enrollment
                FOR EACH ROW
            BEGIN
                IF (SELECT role FROM tbl_user WHERE id = NEW.user_id) &lt;&gt; 'TRAINEE' THEN
                    SIGNAL SQLSTATE '45000'
                    SET MESSAGE_TEXT = 'Cannot enroll a user who is not a TRAINEE.';
                END IF;
            END;
            //
        </sql>
        <rollback>
            <sql>
                DROP TRIGGER IF EXISTS trg_check_enrollment_trainee;
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>